<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>GPXmagic</title>
    <script type="text/javascript" src="../Main.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
</head>

<body>
<div id="myapp"></div>
</body>

<script type="text/javascript">

// Start the Elm application.
var app = Elm.Main.init({
    node: document.getElementById('myapp')
});

app.ports.mapPort.subscribe(incomingMessageHandler);

// We use port messages to synchronise our state here with Elm.
var map;
var isMapCreated = false;
var trackAdded = false;
var dragPointStart;
var dragging = false;

var canvas;
// Make dummy feature just for making drag point feedback.
var drag = {
    'type': 'FeatureCollection',
    'features': [
        {
            'type': 'Feature',
            'geometry': {
                'type': 'Point',
                'coordinates': [0, 0]
            }
        }
    ]
};

function startDraggingPoint(e) {
    canvas.style.cursor = 'grab';

    var coords = e.lngLat;
    drag.features[0].geometry.coordinates = [coords.lng, coords.lat];

    if (dragging) {
        map.removeLayer('drag');
        map.removeSource('drag');
    };

    map.addSource('drag', {
        'type': 'geojson',
        'data': drag
        });

    console.log('adding drag layer');
    map.addLayer({
        'id': 'drag',
        'type': 'circle',
        'source': 'drag',
        'paint': {
            'circle-radius': 5,
            'circle-color': '#ffff00'
        }
    });

    dragging = true;
    dragPointStart = e.lngLat;
    map.on('mousemove', onMove);
    map.once('mouseup', onUp);
};

// Copied from mapbox point dragging example
function onMove(e) {
    var coords = e.lngLat;

    //    console.log(e);

    // Set a UI indicator for dragging.
    canvas.style.cursor = 'grabbing';

    // Note we don't tell Elm until the point is dropped.
    // Update the Point feature in `geojson` coordinates
    // and call setData to the source layer `point` on it.
    drag.features[0].geometry.coordinates = [coords.lng, coords.lat];
    map.getSource('drag').setData(drag);

};

function onUp(e) {
    var coords = e.lngLat;

    canvas.style.cursor = '';
    if (dragging) {
        map.removeLayer('drag');
        map.removeSource('drag');
        dragging = false;
    };

    map.off('mousemove', onMove);
    map.off('touchmove', onMove);

    app.ports.messageReceiver.send
        ( { 'msg' : 'drag'
          , 'start' : dragPointStart
          , 'end' : coords
      } );
};

function incomingMessageHandler(msg) {
    console.log('behold, a message from the land of Elm');

    switch (msg.Cmd) {
        case 'Init':
            if (!isMapCreated) {
                makeTheMap(msg);
            }
            break;

        case 'Track':
            if (isMapCreated) {
                addLineToMap(msg.data, msg.points);
                map.setCenter([msg.lon, msg.lat]);
            }
            break;

        case 'Stop':
            if (isMapCreated) {
                console.log('removing the map');
                map.remove();
                map = null;
                isMapCreated = false;
                trackAdded = false;
                app.ports.mapStopped.send('stopped');
            }

        case 'Mark':
            if (isMapCreated) {
                console.log('adding marker');
                addOptionals(msg);
            }
    }
};

function makeTheMap(msg) {
    console.log('create the map');

    mapboxgl.accessToken = msg.token;
    var element = document.getElementById("map");
    if(typeof(element) != 'undefined' && element != null && !isMapCreated)
    {
        console.log('making the map now');

        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [msg.lon, msg.lat],
            zoom: msg.zoom
        });

        map.on('load', function () {
                console.log('tell Elm the map is ready');
                isMapCreated = true;
                canvas  = map.getCanvasContainer();
                app.ports.messageReceiver.send({ 'msg' : 'map ready' });
        });

        map.on('move', function (event) {
                app.ports.messageReceiver.send
                    ( { 'msg' : 'move'
                      , 'lat' : map.getCenter().lat
                      , 'lon' : map.getCenter().lng
                      , 'zoom' : map.getZoom()
                  } );
        });

        map.on('click', function(e) {
            // The event object (e) contains information like the
            // coordinates of the point on the map that was clicked.
            // console.log('A click event has occurred at ' + e.lngLat);
                app.ports.messageReceiver.send(
                 { 'msg' : 'click'
                 , 'lat' : e.lngLat.lat
                 , 'lon' : e.lngLat.lng
                 } );
        });

    } else {
        //No 'map' node, we have to keep checking.
        console.log('no map node');
        app.ports.messageReceiver.send({ 'msg' : 'no node' });
    }
};


function addLineToMap(data, points) {
    console.log('add line to map');

    if (trackAdded) {
        console.log('removing existing track');
        map.removeLayer('route');
        map.removeSource('route');
        map.removeLayer('points');
        map.removeSource('points');
        trackAdded = false;
    }

    console.log('adding geojson data');
    map.addSource('route', {
        'type': 'geojson',
        'data': data
        });

    console.log('adding route layer');
    map.addLayer({
        'id': 'route',
        'type': 'line',
        'source': 'route',
        'layout': {
        'line-join': 'round',
        'line-cap': 'round'
        },
        'paint': {
            'line-color': '#888',
            'line-width': 8
        }
    });

    console.log('adding geojson data');
    map.addSource('points', {
        'type': 'geojson',
        'data': points
        });

    console.log('adding points layer');
    map.addLayer({
        'id': 'points',
        'type': 'circle',
        'source': 'points',
        'paint': {
            'circle-radius': 5,
            'circle-color': '#ff8f00'
        }
    });

    // When the cursor enters a feature in the point layer, prepare for dragging.
    map.on('mouseenter', 'points', function () {
        canvas.style.cursor = 'move';
    });

    map.on('mouseleave', 'points', function () {
        canvas.style.cursor = '';
    });

    map.on('mousedown', 'points', function (e) {
        // Prevent the default map drag behavior.
        e.preventDefault();
        startDraggingPoint(e);
    });

    trackAdded = true;
    app.ports.messageReceiver.send({ 'msg' : 'track ready' });
};

var orangeMarker = new mapboxgl.Marker({ color: "#FFA500" });
var purpleMarker = new mapboxgl.Marker({ color: "#800080", scale: 0.8 });

function addOptionals(msg) {
    if (typeof(msg.orange) != 'undefined') {
        orangeMarker
            .setLngLat([msg.orange.lon, msg.orange.lat])
            .addTo(map);
    }

    if (typeof(msg.purple) === 'undefined') {
        purpleMarker.remove();
    } else {
        purpleMarker
            .setLngLat([msg.purple.lon, msg.purple.lat])
            .addTo(map);
    };

    // Map API calls not idempotent.
    if (map.getLayer('bend')) map.removeLayer('bend');
    if (map.getSource('bend')) map.removeSource('bend');

    if (typeof(msg.bend) != 'undefined') {
        map.addSource('bend', {
            'type': 'geojson',
            'data': msg.bend
            });

        console.log('adding bend');
        map.addLayer({
            'id': 'bend',
            'type': 'line',
            'source': 'bend',
            'layout': {
            'line-join': 'round',
            'line-cap': 'round'
            },
            'paint': {
                'line-color': '#FEFF57',
                'line-width': 5
            }
        });
    };

    if (map.getLayer('nudge')) map.removeLayer('nudge');
    if (map.getSource('nudge')) map.removeSource('nudge');

    if (typeof(msg.nudge) != 'undefined') {
        map.addSource('nudge', {
            'type': 'geojson',
            'data': msg.nudge
            });

        console.log('adding nudge');
        map.addLayer({
            'id': 'nudge',
            'type': 'line',
            'source': 'nudge',
            'layout': {
            'line-join': 'round',
            'line-cap': 'round'
            },
            'paint': {
                'line-color': '#FFA500',
                'line-width': 5
            }
        });
    };
};

</script>

</html>