<!doctype html>
<html lang="en">
<head>
    <script src="Main.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
    <title>OpenLayers example</title>
</head>
<body>
<h2>GPX viewer requires Javascript</h2>

<script type="text/javascript">


// Start the Elm application.
var app = Elm.Main.init({
    node: document.getElementById('app')
});

app.ports.mapPort.subscribe(function(msg) {
    switch (msg.Cmd) {
        case 'Fly':
            setTheMapPosition(msg);
            break;
    }
});

var map;

function makeTheMap(msg) {
    console.log('setTheMapPosition');
    mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJqYW1lc3dhcmQiLCJhIjoiY2tpbmJpa2U3MTFnYjJ6bXdvYmR5eTZ2aSJ9.LOldXEKf7qhJw9TMyovDGg';
    var element = document.getElementById("map");
    if(typeof(element) != 'undefined' && element != null)
    {
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [msg.lon, msg.lat],
            zoom: msg.zoom
            });

//        map.on('load', setTheMapPosition(msg) );

    };
};

function addLineToMap(data) {
    map.addSource('route', {
        'type': 'geojson',
        'data': msg.data
        });
    map.addLayer({
        'id': 'route',
        'type': 'line',
        'source': 'route',
        'layout': {
        'line-join': 'round',
        'line-cap': 'round'
        },
        'paint': {
            'line-color': '#888',
            'line-width': 8
        }
   });
};

function setTheMapPosition(msg) {
    console.log('setTheMapPosition');
    mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJqYW1lc3dhcmQiLCJhIjoiY2tpbmJpa2U3MTFnYjJ6bXdvYmR5eTZ2aSJ9.LOldXEKf7qhJw9TMyovDGg';

    if (typeof map === "undefined") {
        makeTheMap(msg);
        }
};

function moveend() {
    // console.log('moveend');
    var coordinate = ol.proj.toLonLat(map.getView().getCenter());
    app.ports.mapMoved.send({
        center: {
            lon: coordinate[0],
            lat: coordinate[1]
            },
        zoom: map.getView().getZoom()
    });
}

function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
};

</script>

<div id="app"></div>

</body>
</html>