<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css" type="text/css">
    <style>
      .map {
        height: 500px;
        width: 800px;
      }
    </style>
    <script src="Main.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
    <title>OpenLayers example</title>
</head>
<body>
<h2>GPX viewer requires Javascript</h2>

<script type="text/javascript">

var _map;

// Start the Elm application.
var app = Elm.Main.init({
    node: document.getElementById('app')
});

app.ports.mapPort.subscribe(function(msg) {
    switch (msg.Cmd) {
        case 'Fly':
            setTheMapPosition(msg.lon, msg.lat, msg.zoom);
            break;
    }
});

function setTheMapPosition(lon, lat, zoom) {
    console.log('setTheMapPosition');
    _map = new ol.Map({
        target: 'map',
        layers: [
                new ol.layer.Tile({source: new ol.source.OSM()})
                ],
        view: new ol.View({
                center: ol.proj.fromLonLat([lon, lat]),
                zoom: zoom
                })
        });

    _map.on('moveend', debounce(moveend, 1000, true));
};

function moveend() {
    // console.log('moveend');
    var coordinate = ol.proj.toLonLat(_map.getView().getCenter());
    app.ports.mapMoved.send({
        center: {
            lon: coordinate[0],
            lat: coordinate[1]
            },
        zoom: _map.getView().getZoom()
    });
}

function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
};

</script>

<div id="app"></div>

</body>
</html>